---
title: "Actions"
output:
  html_document

---



```{r setup, include=FALSE}

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = TRUE)

```

# Sources

Copied or adapted from 
[learn by running R scripts on a schedule](https://blog.simonpcouch.com/blog/r-github-actions-commit/)
<br>[jim hester and usethis](https://www.jimhester.com/talk/2020-rsc-github-actions/)
<br>[Bookdown](https://orchid00.github.io/actions_sandbox/understanding-yaml.html#github-action-options); goes with [repo](https://github.com/orchid00/actions_sandbox/tree/main) 

# Why use actions: what you can do 
[Lint](https://github.com/r-lib/actions/blob/master/examples/lint-project.yaml) your code
<br>[Save data](https://blog.simonpcouch.com/blog/r-github-actions-commit/) at regular intervals. 
<br>[send messages](https://github.com/orchid00/actions_sandbox/blob/master/.github/workflows/greetings.yml) in response to issues or pull requests 
<br>[Render](https://github.com/orchid00/actions_sandbox/blob/main/.github/workflows/deploy_bookdown.yml) and deploy, e.g., rmarkdown
<br>[Big list](https://github.com/r-lib/actions/tree/master/examples) for R

# 1. make a folder 
I made a folder in lizre/Downloads/axns. 

# 2. make a package

Why: Making it a package gives access to a lot of helpful tools to tell GitHub Actions, the server you’ll eventually run the script on, how to set up an R session like yours.

<br><b>Here's how to make a package.
<br>Do NOT run this in a package or Rstudio, and do NOT make a git repo first. </b>
<br>Just open plain R from
Applications. If you try to run this in this Rmd console in RStudio, you will get errors
about it being a nested package/project (this is a known issue; see [1](https://github.com/r-lib/usethis/issues/553), [2](https://github.com/r-lib/usethis/issues/1020), [3](https://stackoverflow.com/questions/53819291/how-to-create-an-r-package-nested-in-git-directory))
<br>I used this path because the folder I made in Step 1 is lizre/Downloads/axns, and when I ran
 getwd() in R, it said "lizre".

```{r, eval = FALSE}
usethis::create_package(path = "Downloads/axns")
```

This will make a DESCRIPTION file in the path. In it, if you use any non-base packages in your script, add an Imports: field.(Example of how to user Imports: Line 26 [here ](https://github.com/tidymodels/stacks/blob/main/DESCRIPTION))
<br> Otherwise ignore the DESCRIPTION file.

# 3. Make a repo

Do git init and then [make a github repo](https://github.com/new).
Make it public for Actions [to be free](https://docs.github.com/en/actions/reference/usage-limits-billing-and-administration).

# 4. Make a [.yml](https://docs.github.com/en/actions/learn-github-actions/introduction-to-github-actions#understanding-the-workflow-file) in .github/workflows. 
### This file says what actions to do.

<br>
Check mine out [here](https://github.com/lizre/axns/blob/main/.github/workflows/workflow.yaml).
Maybe copy my one to start.

<br>

# 4. Reading/writing the yaml: setup

<br>The indentation matters.

Following [mine](https://github.com/lizre/axns/blob/main/.github/workflows/workflow.yaml):


### "on": when to trigger actions. 

A time or event.
<br> Example event trigger: On: [push, pull request]

Mine uses a time interval: every hour:
```{r, eval = FALSE}
on:
  schedule:
    - cron: "0 * * * *"
```

generate cron expressions at [here](https://crontab.cronhub.io/).


### The steps

The steps run on a [runner](https://github.com/actions/runner): a server that has the GitHub Actions runner application installed. A runner listens for available jobs, runs one job at a time, and reports the progress, logs, and results back to GitHub. <b>So you have to put everything your code needs on this runner, including your code and an installation of R.</b>

`Checkout` checks out your code from your repo and puts it onto the server where this stuff will run.
<br>`[Setup R](https://github.com/r-lib/actions/tree/master/setup-r)` installs R on that same server.
<br>Now the server has what it needs to run your code!


```{r, eval = FALSE}
jobs:
  job-name_doing-actions:   # put a job name here!
    runs-on: macOS-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
        
        # set up an R session on the Actions server
      - name: Set up R
      - uses: r-lib/actions/setup-r@master
```

### ["Uses"](https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idstepsuses): says what action to use and its version

<br>write them using github repo notation: `{owner}/{repo}@{ref}`
<br>Where ref can be a branch: `uses: actions/setup-node@main`
<br> or version/release:  uses: actions/setup-node@v1
<br>or commit SHA
<br> For example, you can see that the "Set up R" step "uses" r-lib/actions/setup-r@master, which is at 
[https://github.com/r-lib/actions/tree/master/setup-r](https://github.com/r-lib/actions/tree/master/setup-r)


# 5. Reading/writing the yaml: doing things

### Running commands 

```{r, eval = FALSE}
      # Runs a single command using the runners shell
      - name: Run a one-line script
        run: echo Hello, world!

      # Runs a set of commands using the runners shell
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.

```

### Do things in R: without creating a .R

```{r, eval = FALSE}
- run: Rscript -e 'print("hello")'
- run: Rscript -e 'writeLines("text_lines", "my_file1.txt")'
```

### Use variables

Examples, and others, [here](https://docs.github.com/en/actions/quickstart):
  
```{r, eval = FALSE}
- run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
- run: echo "🐧 This job is now running on a ${{ runner.os }} server hosted by GitHub!"
- run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
```

### Do things in R: with a separate .R

```{r, eval = FALSE}
      - name: Generate data
        run: |
          source("R/job.R")
        shell: Rscript {0} 
        
```


### Do things in R: install dependencies

Search for "install" [here](https://github.com/tidymodels/extratests/blob/master/.github/workflows/GH-R-CMD-check.yaml)

### Uploading a file/artifact

https://github.com/lizre/axns/actions/runs/893050999

# Debugging

### Failed workflow: find failing step and errors

[Example](https://github.com/lizre/axns/runs/2706797755?check_suite_focus=true)

```{r, eval = FALSE}
Run Rscript -e 'writeLines("text", paste0("data/", "text", ".txt"))'
Error: Error in file(con, "w") : cannot open the connection
Calls: writeLines -> file
In addition: Warning message:
In file(con, "w") :
  cannot open file 'data/text.txt': No such file or directory
Execution halted
Error: Process completed with exit code 1.
```

### Test Rscript steps 

by running the part after "run" in Terminal. 
<br>However, working in Terminal doesn't mean the workflow will work.
Many of the failed workflow pushes [here](https://github.com/lizre/axns/commits/main/.github/workflows/workflow.yaml)
worked in the Terminal.
<br>For example, [this one](https://github.com/lizre/axns/commit/da12475e7dcb69d9b80f2a79abf98701c01e2a44#diff-fde0e5d64aae13964fdda6d47af304cf1a7015cbc17e440ac4a5e662ee1d875e):
```{r, eval = FALSE}
- run: Rscript -e 'writeLines("text", paste0("data/", "text", ".txt"))'
```

This `Rscript -e 'writeLines("text", paste0("data/", "text", ".txt"))'` worked
 just fine in Terminal and is very simple, but it would not run as a workflow.

### Unresolved: workflow completes but file-creating step doesn't appear to have executed

[This run](https://github.com/lizre/axns/runs/2706803576?check_suite_focus=true): 
Ran successfully but there's no file!
Closest I could get was using the upload-artifact Action:
[this run](https://github.com/lizre/axns/actions/runs/893050999), as [here](https://github.com/actions/upload-artifact) (docs [here](https://docs.github.com/en/actions/guides/storing-workflow-data-as-artifacts)).
But other r scripts don't seem to need to use that. And, the artifact still didn't show up in the repo 
or local directory!!


# Appendix: Advanced links
"Matrix build": a thing to make it go on multiple OSs and multiple versions of R. Start at 8:45 [here](https://www.jimhester.com/talk/2020-rsc-github-actions/)
<br>[detailed syntax](https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions)
<br>[Data version control: pachyderm: MLOps meets DevOps](https://github.blog/2020-10-15-pachyderm-and-the-power-of-github-actions-mlops-meets-devops/)
<br>[linkedin class 1](https://www.linkedin.com/learning/learning-github-actions-2/automating-with-github-actions?u=56745513)
<br>[linkedin class 2](https://www.linkedin.com/learning/learning-github-actions-2019/automating-your-github-workflow?u=56745513)
<br>[https://github.com/learn/devops](https://github.com/learn/devops) : includes Actions
<br>Do on cli https://www.youtube.com/watch?v=UM73gUIoWmE

